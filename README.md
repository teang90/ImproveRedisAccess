# Redis 질의 실패 이슈와 해결

## 1. Redis 질의 실패

### 1-1. 장애 현상

트래픽이 집중되는 시점에 **코어 모듈의 로직 처리 과정에서 간헐적인 실패가 발생했습니다.**  
발생 건수는 **일 평균 약 30~50건** 수준이었으며, 주요 증상은 다음과 같습니다.

- `RedisCommandTimeoutException` 발생
- Redis로부터 **단말 정보 조회 실패**
- 트랜잭션 **실패**

---

### 1-2. 기존 Redis 질의 구조

비즈니스 코어 모듈에서는 트랜잭션 처리 중 다음과 같은 방식으로 Redis를 조회하고 있었습니다.

- 트랜잭션 처리 과정에서
- 폴링방식으로 **0.3초 간격으로 Redis에 GET 요청 수행**
- 트랜잭션 처리에 필요한 데이터 존재 여부를 반복적으로 확인

이와 같은 구조로 인해 트래픽이 집중되는 구간에서 Redis에 과도한 부하가 발생할 가능성이 존재했습니다.

---

### 1-3. 트래픽 분석

모니터링 도구를 통해 확인한 결과,  
**최번시 Redis로 유입되는 요청은 약 30만 TPS** 수준이었습니다.

이를 기반으로 다음과 같은 문제점을 도출했습니다.

- 짧은 주기로 반복 수행되는 Redis GET 요청
- 다수의 트랜잭션에서 동일 데이터에 대한 중복 조회
- Redis 서버 및 Redis Client 리소스 고갈 가능성

---

### 1-4. Redis Client(Lettuce) 이슈 분석

Redis Cluster 연동에는 **Lettuce 라이브러리**를 사용하고 있었습니다.  
관련 자료를 조사하던 중, Lettuce 공식 FAQ에서 다음과 같은 실패 사례를 확인할 수 있었습니다.

#### Lettuce 실패 사례

**서버 과부하 또는 연결 차단**
- 명령이 제한 시간 내에 완료되지 못하는 경우
- Redis 서버가 과부하 상태이거나
- 특정 명령에 의해 연결이 블로킹되는 경우

예시:
- `BLPOP 0`
- 실행 시간이 긴 Lua 스크립트
- `blpop(Duration.ZERO, …)` 사용 시 `RedisCommandTimeoutException` 발생 가능

> 출처  
> https://github.com/redis/lettuce/wiki/Frequently-Asked-Questions

해당 사례가 **본 시스템에서 발생한 실패 증상과 유사하다고 판단했습니다.**

---

## 2. 해결 방안

### 2-1. 구조 개선 필요성

비즈니스 코어 모듈에서 **Redis를 직접 반복 질의하는 구조 자체에 대한 개선이 필요하다고 판단했습니다.**  
단순한 Timeout 설정 조정이나 커넥션 튜닝만으로는 근본적인 해결이 어렵다고 보았습니다.

---

### 2-2. 첫 번째 개선안

내부 메시지 처리를 위해 사용 중이던 **MQ를 활용하여**,  
In 어댑터 모듈에서 코어 모듈로 필요한 데이터를 전달하는 구조를 검토했습니다.

- In 어댑터 모듈 → MQ → 코어 모듈
- Redis 조회를 코어 모듈에서 제거하는 방식

---

### 2-3. 두 번째 개선안

**MQ의 Topic 기반 옵저버 패턴을 활용한 구조입니다.**

- In 어댑터 모듈이 이벤트 발생 시 Topic 발행
- 코어 모듈은 해당 Topic을 구독
- Notification 수신 후 Redis 데이터 조회 수행

---

### 2-4. 개선안 선택 배경

두 번째 개선안을 최종적으로 선택한 이유는 다음과 같습니다.

- 코어 모듈에서 사용하는 데이터가 **캐싱 목적의 Redis 데이터**였음
- 다수의 트랜잭션에서 **동일한 Redis 데이터를 재사용해야 했음**
- Redis를 완전히 제거하기보다는 **조회 시점을 제어하는 구조가 더 적합하다고 판단했음**

---

### 2-5. 최종 적용 구조

- 코어 모듈에서 사용해야 할 데이터는 **In 어댑터 모듈에서 관리**
- In 어댑터 모듈은 MQ를 통해 Topic 발행
- 코어 모듈은 Topic 수신 이후 **필요한 시점에 Redis를 조회**
- 불필요한 Redis 반복 GET 요청 제거

---

## 3. Redis 연동 구조

> (AS-IS / TO-BE 구조도 및 순서도 추가 예정)

- 기존 구조(AS-IS)
![슬라이드3](https://github.com/user-attachments/assets/31923322-6344-44a1-ad3b-6a133faec5f4)

- 개선 구조(TO-BE)
![슬라이드5](https://github.com/user-attachments/assets/f054b016-1903-4ee5-938c-a140da46b9e1)

---

## 4. 개선 결과

- Redis 질의 횟수 대폭 감소
- 트래픽 집중 구간에서도 `RedisCommandTimeoutException` 완전해소
- 코어 모듈 트랜잭션 안정성 향상, CPU 사용감소 95% -> 40%
